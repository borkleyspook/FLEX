name: iOS Build

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  actions: read
  contents: write

jobs:
  build-ios:
    name: Build iOS Project
    runs-on: macOS-latest
    
    strategy:
      matrix:
        scheme: [FLEX]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      run: |
        sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

    - name: List Available Schemes
      run: |
        echo "=== Available schemes ==="
        xcodebuild -workspace "FLEX.xcodeproj/project.xcworkspace" -list

    - name: Install xcpretty
      run: gem install xcpretty

    - name: Clean build directory
      run: |
        rm -rf build artifacts
        mkdir -p build artifacts

    - name: Build FLEX framework
      run: |
        set -o pipefail
        xcodebuild clean -workspace "FLEX.xcodeproj/project.xcworkspace" -scheme FLEX | xcpretty
        
        xcodebuild -workspace "FLEX.xcodeproj/project.xcworkspace" \
          -scheme FLEX \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath ./build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          build | xcpretty

    - name: Find and collect build products
      run: |
        echo "=== Searching for build products ==="
        
        # Search in common locations
        find . -name "*.framework" -o -name "*.a" -o -name "FLEX*" -type f | grep -v ".git" | head -20
        
        # Check build directory structure
        if [ -d "./build" ]; then
          echo "=== Build directory contents ==="
          find ./build -type f -name "*.framework" -o -name "*.a" -o -name "*.app" | head -20
          
          # Copy any found frameworks
          find ./build -name "FLEX.framework" -type d | head -1 | while read framework; do
            echo "Found framework: $framework"
            cp -R "$framework" artifacts/
          done
        fi

        # If no framework found, create a simple success file
        if [ -z "$(ls -A artifacts/ 2>/dev/null)" ]; then
          echo "Build completed successfully - no framework products found" > artifacts/build-success.txt
          echo "Scheme: ${{ matrix.scheme }}" >> artifacts/build-success.txt
          echo "Date: $(date)" >> artifacts/build-success.txt
        fi

        echo "=== Final artifacts ==="
        ls -la artifacts/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ github.run_number }}-${{ matrix.scheme }}
        path: artifacts/
        retention-days: 7

    - name: Create Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ github.run_number }}
        release_name: Build ${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Upload Build to Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: artifacts/*
        tag: build-${{ github.run_number }}
        overwrite: true